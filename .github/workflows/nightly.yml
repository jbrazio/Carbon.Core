# 
#   ______ _______ ______ ______ _______ _______ 
#  |      |   _   |   __ \   __ \       |    |  |
#  |   ---|       |      <   __ <   -   |       |
#  |______|___|___|___|__|______/_______|__|____|
#                         discord.gg/eXPcNKK4yd
# 
name: ðŸŒ™ Nightly build

on:
  # allow manual action trigger
  workflow_dispatch:
  
  schedule:
    - cron: '0 7 * * *'
    # technically this is more a "morningly" build
    # but we do work late.. :-)

jobs:
  nightly:
    name: ðŸŒ™ Update the nightly release tag
  
    runs-on: ubuntu-latest
      
    steps:    
    - name: ðŸ”— Checkout source code from github
      uses: actions/checkout@v3
      with:
        ref: alpha
        
    - name: ðŸ“… Gather information
      id: info
      run: |
        echo "::set-output name=date::$(date +'%Y-%m-%d %H:%M:%S')"
        echo "::set-output name=tag::$(date +'%Yd%j')"
        echo "::set-output name=ref::$(git log -1 '--format=format:%H')"
      
    - name: ðŸ›¤ï¸ Setup the build environment
      uses: actions/setup-dotnet@v2
      with:
        dotnet-version: 6.0.x

    - name: ðŸ“¦ Cache rust managed data and tools
        id: cache-stuff
        uses: actions/cache@v3
        with:
          path: |
            Rust/RustDedicated_Data
            Tools/DepotDownloader/DepotDownloader/bin
            Tools/DepotDownloader/NStrip/bin
          key: stuff

    - steps.cache-stuff.outputs.cache-hit != 'true'
      name: âœ”ï¸ Prepare the build environment
      shell: bash
      run: ${GITHUB_WORKSPACE}/Tools/Build/linux/dev_init.sh

    - name: ðŸ§ Built the application
      shell: bash
      run: ${GITHUB_WORKSPACE}/Tools/Build/linux/dev_release.sh

    - name: ðŸ·ï¸ Update the github release
      uses: andelf/nightly-release@main
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: nightly
        name: 'ðŸŒ™ Nightly build (${{ steps.info.outputs.tag }})'
        prerelease: true
        body: |
          ðŸš¨ This is the nightly build of Carbon.
          The general public is advised to use one of the stable builds.
          This build is targeted at Developers and/or server owners with existing issues.
          
          ðŸ“… Built at ${{ steps.info.outputs.date }} from commit ${{ steps.info.outputs.ref }}.
        files: |
          Release/Carbon.dll
          Release/Carbon.Patch.zip
          Release/Carbon-Unix.dll
          Release/Carbon.Patch-Unix.zip
